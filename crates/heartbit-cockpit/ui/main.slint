import { VerticalBox, HorizontalBox, ScrollView, LineEdit, Button } from "std-widgets.slint";
import { AgentCard, AgentState } from "components/agent_card.slint";
import { ChatMessage, ChatMsg } from "components/chat_message.slint";
import { ApprovalBanner } from "components/approval_banner.slint";
import { QuestionBanner, QuestionOptionData } from "components/question_banner.slint";
import { BlackboardEntry, BlackboardData } from "components/blackboard_entry.slint";
import { StatsBar, TokenStats } from "components/stats_bar.slint";

export struct HistoryEntry {
    id: int,
    task: string,
    status: string,
    cost: string,
    elapsed: string,
    msg-count: int,
}

export { AgentState, ChatMsg, BlackboardData, TokenStats, QuestionOptionData }

export component MainWindow inherits Window {
    title: "Heartbit Cockpit";
    width: 1200px;
    height: 800px;
    background: #0f172a;
    forward-focus: input-field;

    // --- Data models (Rust → Slint) ---
    in property <[AgentState]> agents: [];
    in property <[ChatMsg]> messages: [];
    in property <[BlackboardData]> blackboard-entries: [];
    in property <TokenStats> stats: {
        total-input: "0",
        total-output: "0",
        cache-created: "0",
        cache-read: "0",
        total-cost: "$0.0000",
        tool-calls: "0",
        last-latency: "",
        model: "",
        elapsed: "",
    };
    // "idle", "running", "completed", "failed", "cancelled"
    in property <string> run-status: "idle";
    in property <bool> input-requested: false;
    in property <bool> approval-pending: false;
    in property <string> approval-tool-names: "";
    in property <string> approval-agent-name: "";

    in property <bool> question-pending: false;
    in property <string> question-header: "";
    in property <string> question-text: "";
    in property <bool> question-multiple: false;
    in property <string> question-progress: "";
    in property <[QuestionOptionData]> question-options: [];

    in property <[HistoryEntry]> history-entries: [];
    // -1 = live view, >= 0 = viewing historical run
    in property <int> viewing-history-id: -1;
    // Active agent filter name ("" = no filter)
    in property <string> agent-filter: "";

    // Derived: true when user can submit a new task or reply
    property <bool> can-submit: run-status == "idle" || run-status == "completed"
                              || run-status == "failed" || run-status == "cancelled";

    // --- Callbacks (Slint → Rust) ---
    callback submit-task(string);
    // 0=Allow, 1=Deny, 2=AlwaysAllow, 3=AlwaysDeny
    callback approve(int);
    callback send-input(string);
    callback toggle-tool-output(int);
    callback cancel-task();
    callback select-question-option(int);
    callback submit-question-answers();
    callback copy-to-clipboard(string);
    callback select-history-run(int);
    callback filter-by-agent(string);

    // --- Functions (Rust → Slint) ---
    /// Scroll chat to bottom, but only if the user is already near the bottom
    /// (within 100px). This prevents yanking focus when reading earlier messages.
    public function scroll-chat-to-bottom() {
        // viewport-y is 0 at top, negative when scrolled down.
        // "at bottom" means viewport-y ≈ visible-height - viewport-height
        // (which is the most-negative possible value).
        if chat-scroll.viewport-height <= chat-scroll.visible-height {
            // Content fits without scrolling — nothing to do
            return;
        }
        // Distance from bottom in px (positive = scrolled away from bottom)
        // viewport-y is negative when scrolled; at bottom it equals (visible - viewport)
        // distance = viewport-y - (visible - viewport) = viewport-y - visible + viewport
        // A smaller distance means closer to bottom.
        if chat-scroll.viewport-y - chat-scroll.visible-height + chat-scroll.viewport-height < 100px {
            chat-scroll.viewport-y = chat-scroll.visible-height - chat-scroll.viewport-height;
        }
    }

    public function focus-input() {
        input-field.focus();
    }

    HorizontalBox {
        // ======= LEFT PANEL: Agents + History =======
        VerticalBox {
            width: root.width * 25%;
            padding: 12px;
            spacing: 8px;

            Text {
                text: "Agents";
                color: #e2e8f0;
                font-size: 16px;
                font-weight: 700;
                vertical-stretch: 0;
            }

            if agents.length == 0 && history-entries.length == 0 : Text {
                text: "Run a task to see agents";
                color: #475569;
                font-size: 12px;
                vertical-stretch: 0;
            }

            // Agent cards (compact, don't stretch) — click to filter messages
            if agents.length > 0 : VerticalLayout {
                spacing: 8px;
                vertical-stretch: 0;
                for agent in agents : AgentCard {
                    agent: agent;
                    clicked => { root.filter-by-agent(agent.name); }
                }
            }

            // History section
            if history-entries.length > 0 : Text {
                text: "History";
                color: #e2e8f0;
                font-size: 14px;
                font-weight: 600;
                vertical-stretch: 0;
            }

            // "Back to live" button when viewing history
            if viewing-history-id >= 0 : back-ta := TouchArea {
                vertical-stretch: 0;
                height: 28px;
                clicked => { root.select-history-run(-1); }
                Rectangle {
                    background: back-ta.has-hover ? #254a74 : #1e3a5f;
                    border-radius: 6px;
                    HorizontalLayout {
                        padding-left: 8px;
                        padding-right: 8px;
                        alignment: center;
                        Text {
                            text: "← Back to live";
                            color: #60a5fa;
                            font-size: 12px;
                            font-weight: 600;
                        }
                    }
                }
            }

            ScrollView {
                VerticalLayout {
                    alignment: start;
                    spacing: 4px;
                    padding: 0px;

                    for entry in history-entries : history-ta := TouchArea {
                        height: 52px;
                        vertical-stretch: 0;
                        clicked => { root.select-history-run(entry.id); }

                        Rectangle {
                            background: entry.id == viewing-history-id ? #2563eb :
                                       history-ta.has-hover ? #263548 : #1e293b;
                            border-radius: 6px;

                            VerticalLayout {
                                padding: 8px;
                                spacing: 2px;

                                Text {
                                    text: entry.task;
                                    color: #e2e8f0;
                                    font-size: 12px;
                                    overflow: elide;
                                }

                                HorizontalLayout {
                                    spacing: 8px;
                                    Rectangle {
                                        width: 6px;
                                        height: 6px;
                                        border-radius: 3px;
                                        background: entry.status == "completed" ? #10b981 :
                                                   entry.status == "failed" ? #ef4444 :
                                                   entry.status == "cancelled" ? #f97316 :
                                                   #6b7280;
                                    }
                                    Text {
                                        text: entry.cost;
                                        color: #64748b;
                                        font-size: 11px;
                                    }
                                    if entry.elapsed != "" : Text {
                                        text: entry.elapsed;
                                        color: #64748b;
                                        font-size: 11px;
                                    }
                                    Text {
                                        text: entry.msg-count + " msgs";
                                        color: #64748b;
                                        font-size: 11px;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // ======= CENTER PANEL: Conversation =======
        VerticalBox {
            width: root.width * 50%;
            padding: 12px;
            spacing: 8px;

            // Status indicator
            Rectangle {
                background: run-status == "running" ? #1e3a5f :
                           run-status == "completed" ? #14532d :
                           run-status == "failed" ? #7f1d1d :
                           run-status == "cancelled" ? #78350f :
                           #1e293b;
                border-radius: 6px;
                height: 28px;
                vertical-stretch: 0;

                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    alignment: center;
                    spacing: 8px;

                    // Status dot
                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: run-status == "running" ? #3b82f6 :
                                   run-status == "completed" ? #10b981 :
                                   run-status == "failed" ? #ef4444 :
                                   run-status == "cancelled" ? #f97316 :
                                   #6b7280;
                    }
                    Text {
                        text: run-status == "running" ? (question-pending ? "Awaiting answer" : input-requested ? "Awaiting input" : "Running...") :
                              run-status == "completed" ? "Completed" :
                              run-status == "failed" ? "Failed" :
                              run-status == "cancelled" ? "Cancelled" :
                              "Ready";
                        color: #e2e8f0;
                        font-size: 12px;
                    }
                }
            }

            // Filter indicator — shown when viewing messages from a single agent
            if agent-filter != "" : filter-ta := TouchArea {
                vertical-stretch: 0;
                height: 24px;
                clicked => { root.filter-by-agent(agent-filter); }
                Rectangle {
                    background: filter-ta.has-hover ? #3b4b6b : #334155;
                    border-radius: 4px;
                    HorizontalLayout {
                        padding-left: 8px;
                        padding-right: 8px;
                        alignment: center;
                        spacing: 6px;
                        Text {
                            text: "Showing: " + agent-filter;
                            color: #94a3b8;
                            font-size: 11px;
                        }
                        Text {
                            text: "✕";
                            color: #64748b;
                            font-size: 11px;
                        }
                    }
                }
            }

            chat-scroll := ScrollView {
                VerticalLayout {
                    alignment: start;
                    spacing: 6px;
                    padding: 0px;
                    for msg in messages : ChatMessage {
                        msg: msg;
                        toggle-expand => {
                            root.toggle-tool-output(msg.id);
                        }
                        copy-text(text) => {
                            root.copy-to-clipboard(text);
                        }
                    }
                }
            }

            ApprovalBanner {
                visible-approval: approval-pending;
                tool-names: approval-tool-names;
                agent-name: approval-agent-name;
                respond(choice) => { root.approve(choice); }
            }

            QuestionBanner {
                visible-question: question-pending;
                header: question-header;
                question-text: question-text;
                multiple: question-multiple;
                progress: question-progress;
                options: question-options;
                select-option(idx) => { root.select-question-option(idx); }
                submit-answers => { root.submit-question-answers(); }
            }

            // Input area
            HorizontalBox {
                spacing: 8px;
                padding-top: 4px;

                input-field := LineEdit {
                    placeholder-text: question-pending ? "Answer above..." :
                                     input-requested ? "Type your reply..." :
                                     run-status == "running" ? "Running..." :
                                     "Enter a task...";
                    enabled: (can-submit || input-requested) && !question-pending;
                    accepted(text) => {
                        if can-submit {
                            root.submit-task(self.text);
                            self.text = "";
                        } else if input-requested {
                            root.send-input(self.text);
                            self.text = "";
                        }
                    }
                }

                if run-status == "running" && !input-requested : Button {
                    text: "Cancel";
                    clicked => { root.cancel-task(); }
                }

                Button {
                    text: input-requested ? "Send" :
                          run-status == "running" ? "..." :
                          "Run";
                    enabled: (can-submit || input-requested) && !question-pending;
                    clicked => {
                        if can-submit {
                            root.submit-task(input-field.text);
                            input-field.text = "";
                        } else if input-requested {
                            root.send-input(input-field.text);
                            input-field.text = "";
                        }
                    }
                }
            }
        }

        // ======= RIGHT PANEL: Inspector =======
        VerticalBox {
            width: root.width * 25%;
            padding: 12px;
            spacing: 8px;

            StatsBar {
                stats: stats;
            }

            Text {
                text: "Blackboard";
                color: #e2e8f0;
                font-size: 14px;
                font-weight: 600;
            }

            if blackboard-entries.length == 0 : Text {
                text: "No entries yet";
                color: #475569;
                font-size: 12px;

                vertical-stretch: 0;
            }

            ScrollView {
                VerticalLayout {
                    alignment: start;
                    spacing: 6px;
                    padding: 0px;
                    for entry in blackboard-entries : BlackboardEntry {
                        entry: entry;
                    }
                }
            }
        }
    }
}
